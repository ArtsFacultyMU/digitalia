#!/bin/bash

if [ $# -ne 1 ]
then
	echo "Usage: islandora-security-setup devel|production"
	exit 0
fi

servertype=$1

adduser --disabled-password --gecos "" islandora
chown -R islandora:islandora /var/www/html/*
chmod -R o-w /var/www/html/*
chgrp -R www-data /var/www/html/drupal/web/sites/default/files
chmod -R g+w /var/www/html/drupal/web/sites/default/files

if [ $servertype == 'production' ]
then
	cat islandora-twpol.txt > '/etc/tripwire/twpol.txt'
	twadmin -m P -S /etc/tripwire/site.key /etc/tripwire/twpol.txt
	tripwire -m i
fi

mkdir -p /root/backup

su - islandora -c 'mkdir -p /home/islandora/logs/'
su - islandora -c 'mkdir -p /home/islandora/bin/'

mv -v islandora-security-setup-islandora /home/islandora/bin
mv -v islandora-security-update /home/islandora/bin
mv -v islandora-security-check /home/islandora/bin
chown -R islandora:islandora /home/islandora/bin

su - islandora -c '~/bin/islandora-security-setup-islandora'

#add-apt-repository --yes ppa:certbot/certbot
#certbot --apache -m kic_admins@ics.muni.cz --agree-tos -d dan-demo.phil.muni.cz
